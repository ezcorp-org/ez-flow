# Story 3.7: Production Installers - macOS

## Status

Draft

## Story

**As a** macOS user,
**I want** a standard DMG installer,
**so that** I can drag EZ Flow to Applications like any Mac app.

## Acceptance Criteria

1. DMG with app bundle and Applications folder shortcut
2. App properly signed and notarized for Gatekeeper
3. Universal binary (Intel + Apple Silicon) or separate builds
4. App icon and metadata properly configured
5. First launch handles macOS security prompts gracefully
6. Works on macOS 12+ (Monterey and later)
7. DMG background image with branding (optional but polished)

## Tasks / Subtasks

- [ ] **Task 1: Configure DMG Build** (AC: 1)
  - [ ] Set up DMG in tauri.conf.json
  - [ ] Configure DMG layout
  - [ ] Test basic DMG generation

- [ ] **Task 2: Configure App Bundle Metadata** (AC: 4)
  - [ ] Set CFBundleName, CFBundleIdentifier
  - [ ] Configure version info
  - [ ] Set app category

- [ ] **Task 3: Create App Icons** (AC: 4)
  - [ ] Design 1024x1024 app icon
  - [ ] Generate iconset (16-1024px)
  - [ ] Create .icns file
  - [ ] Set in Info.plist

- [ ] **Task 4: Build Universal Binary** (AC: 3)
  - [ ] Add aarch64-apple-darwin target
  - [ ] Add x86_64-apple-darwin target
  - [ ] Use `lipo` to create universal binary
  - [ ] Or create separate builds

- [ ] **Task 5: Configure Code Signing** (AC: 2)
  - [ ] Set up Apple Developer ID certificate
  - [ ] Configure signing in CI
  - [ ] Sign app bundle with hardened runtime

- [ ] **Task 6: Configure Notarization** (AC: 2)
  - [ ] Set up notarytool in CI
  - [ ] Submit for notarization
  - [ ] Staple notarization ticket

- [ ] **Task 7: Handle Security Prompts** (AC: 5)
  - [ ] Document microphone permission flow
  - [ ] Handle Accessibility permission
  - [ ] Provide user guidance in onboarding

- [ ] **Task 8: Create DMG Background** (AC: 7)
  - [ ] Design branded background image
  - [ ] Configure DMG window size
  - [ ] Position icons properly

- [ ] **Task 9: Test on Minimum Version** (AC: 6)
  - [ ] Test on macOS 12 Monterey
  - [ ] Verify all features work
  - [ ] Set minimum deployment target

- [ ] **Task 10: Add Tests**
  - [ ] Test DMG mounts correctly
  - [ ] Test app launches after drag-install
  - [ ] Test on both Intel and Apple Silicon

## Dev Notes

### Tauri macOS Configuration

```json
// src-tauri/tauri.conf.json
{
  "bundle": {
    "active": true,
    "category": "public.app-category.productivity",
    "targets": ["dmg", "app"],
    "macOS": {
      "entitlements": "./entitlements.plist",
      "exceptionDomain": null,
      "frameworks": [],
      "minimumSystemVersion": "12.0",
      "signingIdentity": "-",
      "providerShortName": null
    }
  }
}
```

### Entitlements

```xml
<!-- src-tauri/entitlements.plist -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.security.app-sandbox</key>
    <false/>
    <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
    <true/>
    <key>com.apple.security.device.audio-input</key>
    <true/>
    <key>com.apple.security.automation.apple-events</key>
    <true/>
    <key>com.apple.security.cs.disable-library-validation</key>
    <true/>
</dict>
</plist>
```

### Universal Binary Build

```yaml
# .github/workflows/release.yml
jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust targets
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Build ARM64
        run: cargo tauri build --target aarch64-apple-darwin --features metal

      - name: Build x64
        run: cargo tauri build --target x86_64-apple-darwin

      - name: Create Universal Binary
        run: |
          mkdir -p universal
          lipo -create \
            target/aarch64-apple-darwin/release/bundle/macos/EZFlow.app/Contents/MacOS/EZFlow \
            target/x86_64-apple-darwin/release/bundle/macos/EZFlow.app/Contents/MacOS/EZFlow \
            -output universal/EZFlow
```

### Code Signing and Notarization

```yaml
# .github/workflows/release.yml
- name: Import certificates
  env:
    APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
    APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
  run: |
    echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
    security create-keychain -p "" build.keychain
    security import certificate.p12 -k build.keychain -P $APPLE_CERTIFICATE_PASSWORD -T /usr/bin/codesign
    security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

- name: Sign app
  run: |
    codesign --deep --force --verify --verbose --sign "Developer ID Application: Your Name" \
      --options runtime \
      target/release/bundle/macos/EZFlow.app

- name: Create DMG
  run: |
    hdiutil create -volname "EZ Flow" -srcfolder target/release/bundle/macos/EZFlow.app \
      -ov -format UDZO EZFlow.dmg

- name: Notarize
  env:
    APPLE_ID: ${{ secrets.APPLE_ID }}
    APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
    APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
  run: |
    xcrun notarytool submit EZFlow.dmg \
      --apple-id "$APPLE_ID" \
      --password "$APPLE_PASSWORD" \
      --team-id "$APPLE_TEAM_ID" \
      --wait

    xcrun stapler staple EZFlow.dmg
```

### DMG Background Setup

```bash
# Create DMG with custom background
# Use create-dmg tool
brew install create-dmg

create-dmg \
  --volname "EZ Flow" \
  --background "dmg-background.png" \
  --window-pos 200 120 \
  --window-size 600 400 \
  --icon-size 100 \
  --icon "EZFlow.app" 150 190 \
  --hide-extension "EZFlow.app" \
  --app-drop-link 450 185 \
  "EZFlow.dmg" \
  "target/release/bundle/macos/"
```

### Info.plist Configuration

```xml
<!-- Automatically generated, but verify these -->
<key>CFBundleName</key>
<string>EZ Flow</string>
<key>CFBundleIdentifier</key>
<string>com.ezflow.app</string>
<key>CFBundleVersion</key>
<string>1.0.0</string>
<key>LSMinimumSystemVersion</key>
<string>12.0</string>
<key>NSMicrophoneUsageDescription</key>
<string>EZ Flow needs microphone access to transcribe your speech.</string>
<key>LSApplicationCategoryType</key>
<string>public.app-category.productivity</string>
```

### File Locations

| File | Purpose |
|------|---------|
| `src-tauri/tauri.conf.json` | macOS bundle config |
| `src-tauri/entitlements.plist` | App entitlements |
| `src-tauri/icons/icon.icns` | macOS app icon |
| `assets/dmg-background.png` | DMG background image |

### Testing

**Manual Testing Checklist**:
- [ ] DMG mounts on macOS 12
- [ ] DMG mounts on macOS 13
- [ ] DMG mounts on macOS 14
- [ ] Drag to Applications works
- [ ] App opens without Gatekeeper warning
- [ ] Microphone permission prompt appears
- [ ] App works on Intel Mac
- [ ] App works on Apple Silicon Mac

**Automated Tests**:
```bash
# Mount DMG
hdiutil attach EZFlow.dmg

# Verify app exists
ls -la "/Volumes/EZ Flow/EZFlow.app"

# Verify signature
codesign --verify --deep --strict "/Volumes/EZ Flow/EZFlow.app"

# Verify notarization
spctl --assess --type execute "/Volumes/EZ Flow/EZFlow.app"

# Unmount
hdiutil detach "/Volumes/EZ Flow"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
