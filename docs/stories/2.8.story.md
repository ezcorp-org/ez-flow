# Story 2.8: First-Run Onboarding

## Status

Ready for Review

## Story

**As a** new user,
**I want** a guided setup experience,
**so that** I can get EZ Flow working correctly without reading documentation.

## Acceptance Criteria

1. Onboarding wizard launches on first run (or if no model downloaded)
2. Step 1: Welcome screen explaining what EZ Flow does
3. Step 2: Microphone permission request with platform-specific guidance
4. Step 3: Model selection and download with size/quality explanation
5. Step 4: Hotkey configuration with test recording
6. Step 5: Success screen with quick tips
7. "Skip" option available (can complete setup later in Settings)
8. Onboarding state persisted so it doesn't repeat
9. Can re-run onboarding from Settings ("Setup Wizard")

## Tasks / Subtasks

- [ ] **Task 1: Create Onboarding Window** (AC: 1)
  - [ ] Create new Tauri window for onboarding
  - [ ] Configure as modal, centered
  - [ ] Create `src/routes/onboarding/+page.svelte`
  - [ ] Check for first-run state on app startup

- [ ] **Task 2: Implement Onboarding State** (AC: 8)
  - [ ] Add `onboarding_completed` to settings
  - [ ] Check on app startup
  - [ ] Show onboarding if false or no model downloaded
  - [ ] Set true on completion

- [ ] **Task 3: Create Wizard Step Component** (AC: 1-5)
  - [ ] Create `src/lib/components/OnboardingWizard.svelte`
  - [ ] Implement step navigation
  - [ ] Progress indicator (dots or bar)
  - [ ] Next/Back buttons

- [ ] **Task 4: Welcome Step (Step 1)** (AC: 2)
  - [ ] Display EZ Flow logo/name
  - [ ] Brief explanation of features
  - [ ] "Get Started" button
  - [ ] EZCorp branding styling

- [ ] **Task 5: Microphone Permission Step (Step 2)** (AC: 3)
  - [ ] Check current permission status
  - [ ] Show request permission button
  - [ ] Display platform-specific instructions
  - [ ] Show success checkmark when granted
  - [ ] Allow skip with warning

- [ ] **Task 6: Model Selection Step (Step 3)** (AC: 4)
  - [ ] Display model options with sizes
  - [ ] Explain quality/speed tradeoff
  - [ ] Recommend "Base" for most users
  - [ ] Show download progress
  - [ ] Allow skip (download later)

- [ ] **Task 7: Hotkey Configuration Step (Step 4)** (AC: 5)
  - [ ] Show default hotkey
  - [ ] Allow hotkey customization
  - [ ] "Test Recording" button
  - [ ] Play back or show transcription result
  - [ ] Confirm hotkey works

- [ ] **Task 8: Success Step (Step 5)** (AC: 6)
  - [ ] Celebration message
  - [ ] Quick tips for using EZ Flow
  - [ ] "Start Using EZ Flow" button
  - [ ] Option to open settings

- [ ] **Task 9: Implement Skip Functionality** (AC: 7)
  - [ ] Add "Skip" link on each step
  - [ ] Confirm skip action
  - [ ] Mark onboarding as skipped (not completed)
  - [ ] Show reminder in settings

- [ ] **Task 10: Re-run from Settings** (AC: 9)
  - [ ] Add "Run Setup Wizard" button in Settings
  - [ ] Reset onboarding state
  - [ ] Open onboarding window

- [ ] **Task 11: Add E2E Tests**
  - [ ] Test onboarding appears on first run
  - [ ] Test step navigation
  - [ ] Test skip functionality
  - [ ] Test completion state persists

## Dev Notes

### Onboarding State in Settings

```rust
// src-tauri/src/models/settings.rs - Add field
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Settings {
    // ... other fields

    #[serde(default)]
    pub onboarding_completed: bool,
    #[serde(default)]
    pub onboarding_skipped: bool,
}
```

### Onboarding Wizard Component

```svelte
<!-- src/lib/components/OnboardingWizard.svelte -->
<script lang="ts">
  import { createEventDispatcher } from 'svelte';
  import WelcomeStep from './onboarding/WelcomeStep.svelte';
  import PermissionsStep from './onboarding/PermissionsStep.svelte';
  import ModelStep from './onboarding/ModelStep.svelte';
  import HotkeyStep from './onboarding/HotkeyStep.svelte';
  import SuccessStep from './onboarding/SuccessStep.svelte';

  const dispatch = createEventDispatcher();

  let currentStep = 0;
  const steps = ['Welcome', 'Permissions', 'Model', 'Hotkey', 'Ready'];

  function next() {
    if (currentStep < steps.length - 1) {
      currentStep++;
    } else {
      dispatch('complete');
    }
  }

  function back() {
    if (currentStep > 0) {
      currentStep--;
    }
  }

  function skip() {
    if (confirm('Skip setup? You can complete it later in Settings.')) {
      dispatch('skip');
    }
  }
</script>

<div class="min-h-screen bg-neutral-900 flex flex-col">
  <!-- Progress -->
  <div class="p-6">
    <div class="flex justify-center gap-2">
      {#each steps as step, i}
        <div
          class="w-2 h-2 rounded-full transition-colors"
          class:bg-yellow-400={i <= currentStep}
          class:bg-neutral-700={i > currentStep}
        ></div>
      {/each}
    </div>
  </div>

  <!-- Step Content -->
  <div class="flex-1 flex items-center justify-center p-6">
    {#if currentStep === 0}
      <WelcomeStep />
    {:else if currentStep === 1}
      <PermissionsStep on:granted={next} />
    {:else if currentStep === 2}
      <ModelStep on:downloaded={next} />
    {:else if currentStep === 3}
      <HotkeyStep />
    {:else if currentStep === 4}
      <SuccessStep />
    {/if}
  </div>

  <!-- Navigation -->
  <div class="p-6 flex justify-between">
    <div>
      {#if currentStep > 0}
        <button class="px-4 py-2 text-neutral-400" on:click={back}>
          Back
        </button>
      {/if}
    </div>

    <div class="flex gap-4">
      <button class="px-4 py-2 text-neutral-500" on:click={skip}>
        Skip
      </button>
      <button
        class="px-6 py-2 bg-yellow-400 text-black rounded-lg font-medium"
        on:click={next}
      >
        {currentStep === steps.length - 1 ? 'Finish' : 'Next'}
      </button>
    </div>
  </div>
</div>
```

### Welcome Step

```svelte
<!-- src/lib/components/onboarding/WelcomeStep.svelte -->
<script lang="ts">
</script>

<div class="text-center max-w-md">
  <div class="w-20 h-20 bg-yellow-400 rounded-2xl mx-auto mb-6 flex items-center justify-center">
    <!-- Logo icon -->
    <svg class="w-12 h-12" viewBox="0 0 24 24" fill="black">
      <!-- Waveform icon -->
    </svg>
  </div>

  <h1 class="text-3xl font-bold mb-4">Welcome to EZ Flow</h1>

  <p class="text-neutral-400 text-lg leading-relaxed">
    Turn your voice into text instantly. Just hold a hotkey, speak, and your words appear wherever you're typing.
  </p>

  <ul class="mt-8 text-left space-y-3">
    <li class="flex items-center gap-3">
      <span class="w-6 h-6 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center text-sm">âœ“</span>
      <span>100% local - your audio never leaves your device</span>
    </li>
    <li class="flex items-center gap-3">
      <span class="w-6 h-6 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center text-sm">âœ“</span>
      <span>Works with any application</span>
    </li>
    <li class="flex items-center gap-3">
      <span class="w-6 h-6 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center text-sm">âœ“</span>
      <span>Free and open source</span>
    </li>
  </ul>
</div>
```

### Permissions Step

```svelte
<!-- src/lib/components/onboarding/PermissionsStep.svelte -->
<script lang="ts">
  import { createEventDispatcher, onMount } from 'svelte';
  import { invoke } from '@tauri-apps/api/core';

  const dispatch = createEventDispatcher();

  let permissionStatus: 'unknown' | 'denied' | 'granted' = 'unknown';
  let platform = 'unknown';

  onMount(async () => {
    platform = await invoke('get_platform');
    permissionStatus = await invoke('check_microphone_permission');
    if (permissionStatus === 'granted') {
      dispatch('granted');
    }
  });

  async function requestPermission() {
    try {
      await invoke('request_microphone_permission');
      permissionStatus = await invoke('check_microphone_permission');
      if (permissionStatus === 'granted') {
        dispatch('granted');
      }
    } catch (e) {
      console.error('Permission request failed', e);
    }
  }
</script>

<div class="text-center max-w-md">
  <div class="w-16 h-16 bg-neutral-800 rounded-full mx-auto mb-6 flex items-center justify-center">
    ðŸŽ¤
  </div>

  <h2 class="text-2xl font-bold mb-4">Microphone Access</h2>

  <p class="text-neutral-400 mb-8">
    EZ Flow needs access to your microphone to transcribe your speech.
  </p>

  {#if permissionStatus === 'granted'}
    <div class="bg-green-500/20 text-green-400 rounded-lg p-4 mb-6">
      âœ“ Microphone access granted
    </div>
  {:else}
    <button
      class="px-6 py-3 bg-yellow-400 text-black rounded-lg font-medium mb-6"
      on:click={requestPermission}
    >
      Grant Microphone Access
    </button>

    {#if platform === 'macos'}
      <p class="text-sm text-neutral-500">
        You'll see a system dialog asking for microphone permission.
        Click "Allow" to continue.
      </p>
    {/if}
  {/if}
</div>
```

### Model Selection Step

```svelte
<!-- src/lib/components/onboarding/ModelStep.svelte -->
<script lang="ts">
  import { createEventDispatcher, onMount } from 'svelte';
  import { invoke } from '@tauri-apps/api/core';
  import { listen } from '@tauri-apps/api/event';

  const dispatch = createEventDispatcher();

  interface Model {
    id: string;
    name: string;
    size_mb: number;
    downloaded: boolean;
  }

  let models: Model[] = [];
  let selectedModel = 'base';
  let downloading = false;
  let progress = 0;

  onMount(async () => {
    models = await invoke('get_available_models');
    const downloaded = models.filter(m => m.downloaded);
    if (downloaded.length > 0) {
      selectedModel = downloaded[0].id;
    }
  });

  async function downloadModel() {
    downloading = true;

    const unlisten = await listen('model:download_progress', (event: any) => {
      progress = event.payload.progress * 100;
    });

    try {
      await invoke('download_model', { modelId: selectedModel });
      dispatch('downloaded');
    } finally {
      unlisten();
      downloading = false;
    }
  }
</script>

<div class="max-w-lg">
  <h2 class="text-2xl font-bold mb-4 text-center">Choose a Model</h2>

  <p class="text-neutral-400 mb-6 text-center">
    Larger models are more accurate but slower. We recommend "Base" for most users.
  </p>

  <div class="space-y-3 mb-6">
    {#each models as model}
      <label
        class="flex items-center p-4 bg-neutral-800 rounded-lg cursor-pointer border-2 transition-colors"
        class:border-yellow-400={selectedModel === model.id}
        class:border-transparent={selectedModel !== model.id}
      >
        <input
          type="radio"
          bind:group={selectedModel}
          value={model.id}
          class="mr-4"
        />
        <div class="flex-1">
          <div class="flex justify-between">
            <span class="font-medium">{model.name}</span>
            <span class="text-neutral-500">{model.size_mb} MB</span>
          </div>
          {#if model.id === 'base'}
            <span class="text-xs text-yellow-400">Recommended</span>
          {/if}
        </div>
        {#if model.downloaded}
          <span class="text-green-400 ml-4">âœ“</span>
        {/if}
      </label>
    {/each}
  </div>

  {#if downloading}
    <div class="mb-4">
      <div class="h-2 bg-neutral-700 rounded-full overflow-hidden">
        <div class="h-full bg-yellow-400" style="width: {progress}%"></div>
      </div>
      <p class="text-sm text-neutral-400 mt-2 text-center">
        Downloading... {Math.round(progress)}%
      </p>
    </div>
  {:else}
    <button
      class="w-full px-6 py-3 bg-yellow-400 text-black rounded-lg font-medium"
      on:click={downloadModel}
    >
      Download {models.find(m => m.id === selectedModel)?.name || 'Model'}
    </button>
  {/if}
</div>
```

### File Locations

| File | Purpose |
|------|---------|
| `src/routes/onboarding/+page.svelte` | Onboarding page |
| `src/lib/components/OnboardingWizard.svelte` | Wizard container |
| `src/lib/components/onboarding/WelcomeStep.svelte` | Step 1 |
| `src/lib/components/onboarding/PermissionsStep.svelte` | Step 2 |
| `src/lib/components/onboarding/ModelStep.svelte` | Step 3 |
| `src/lib/components/onboarding/HotkeyStep.svelte` | Step 4 |
| `src/lib/components/onboarding/SuccessStep.svelte` | Step 5 |

### Testing

**E2E Tests**:
```typescript
test('onboarding shows on first run', async ({ page }) => {
  // Clear settings to simulate first run
  await invoke('reset_settings');

  // Restart app
  await page.reload();

  await expect(page.locator('[data-testid="onboarding-wizard"]')).toBeVisible();
  await expect(page.locator('[data-testid="welcome-step"]')).toBeVisible();
});

test('onboarding can be skipped', async ({ page }) => {
  await page.click('[data-testid="skip-btn"]');
  await page.click('[data-testid="confirm-skip"]');

  // Should close and not show again
  await page.reload();
  await expect(page.locator('[data-testid="onboarding-wizard"]')).not.toBeVisible();
});

test('onboarding can be re-run from settings', async ({ page }) => {
  await page.click('[data-testid="settings-btn"]');
  await page.click('[data-testid="run-setup-wizard"]');

  await expect(page.locator('[data-testid="onboarding-wizard"]')).toBeVisible();
});
```

**Test IDs**:
```typescript
const testIds = {
  onboardingWizard: 'onboarding-wizard',
  welcomeStep: 'welcome-step',
  permissionsStep: 'permissions-step',
  modelStep: 'model-step',
  hotkeyStep: 'hotkey-step',
  successStep: 'success-step',
  nextBtn: 'next-btn',
  backBtn: 'back-btn',
  skipBtn: 'skip-btn',
  finishBtn: 'finish-btn',
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
