# Story 1.2: System Tray Integration

## Status

Draft

## Story

**As a** user,
**I want** EZ Flow to live in my system tray,
**so that** it's always accessible without cluttering my taskbar or dock.

## Acceptance Criteria

1. App starts minimized to system tray (no main window on launch)
2. Tray icon displays EZ Flow logo/placeholder icon
3. Tray menu includes: "About", separator, "Quit"
4. Clicking "Quit" exits the application cleanly
5. Tray icon works correctly on Windows, macOS, and Linux
6. App appears in system tray on system startup (optional setting - default off)

## Tasks / Subtasks

- [ ] **Task 1: Configure Tauri for System Tray** (AC: 1, 2)
  - [ ] Add `tray-icon` feature to Tauri dependencies in `Cargo.toml`
  - [ ] Create tray icon assets in `src-tauri/icons/` (32x32, 64x64 PNG)
  - [ ] Configure `tauri.conf.json` with tray settings
  - [ ] Set `"windows": [{ "visible": false }]` for no main window on launch

- [ ] **Task 2: Implement Tray Icon Setup in Rust** (AC: 2, 5)
  - [ ] Create `src-tauri/src/services/tray.rs` module
  - [ ] Initialize `TrayIconBuilder` in `main.rs` or `lib.rs`
  - [ ] Load icon from embedded resources
  - [ ] Handle platform-specific icon requirements:
    - Windows: ICO or PNG
    - macOS: Template image (monochrome for menu bar)
    - Linux: PNG with transparency

- [ ] **Task 3: Create Tray Menu** (AC: 3)
  - [ ] Build menu with `Menu` and `MenuItem` from Tauri
  - [ ] Add "About EZ Flow" menu item
  - [ ] Add separator using `PredefinedMenuItem::separator()`
  - [ ] Add "Quit" menu item

- [ ] **Task 4: Implement Menu Event Handlers** (AC: 3, 4)
  - [ ] Handle "About" click → show about dialog or window
  - [ ] Handle "Quit" click → clean shutdown via `app.exit(0)`
  - [ ] Register menu event listener in Tauri setup

- [ ] **Task 5: Implement Clean Application Shutdown** (AC: 4)
  - [ ] Ensure all async tasks are cancelled on quit
  - [ ] Save any pending state before exit
  - [ ] Release system resources (audio devices, hotkeys)
  - [ ] Log shutdown sequence with tracing

- [ ] **Task 6: Cross-Platform Testing** (AC: 5)
  - [ ] Test tray icon appearance on Windows
  - [ ] Test tray icon appearance on macOS (menu bar)
  - [ ] Test tray icon appearance on Linux (AppIndicator)
  - [ ] Verify menu opens correctly on all platforms

- [ ] **Task 7: Startup Launch Option** (AC: 6)
  - [ ] Add `launch_at_login` field to Settings model
  - [ ] Implement platform-specific auto-start:
    - Windows: Registry or Startup folder
    - macOS: LaunchAgent or Login Items
    - Linux: XDG autostart desktop file
  - [ ] Default to `false`
  - [ ] Create Tauri command to toggle setting

- [ ] **Task 8: Add Unit Tests**
  - [ ] Test menu creation
  - [ ] Test event handler registration
  - [ ] Test settings persistence for auto-start

## Dev Notes

### Dependencies [Source: architecture.md#2.2]

Add to `src-tauri/Cargo.toml`:
```toml
[dependencies]
tauri = { version = "2", features = ["tray-icon"] }
```

### Tray Icon Setup [Source: architecture.md#4]

```rust
// src-tauri/src/main.rs
use tauri::{
    tray::{TrayIconBuilder, MouseButton, MouseButtonState},
    menu::{Menu, MenuItem, PredefinedMenuItem},
    Manager,
};

fn main() {
    tauri::Builder::default()
        .setup(|app| {
            let quit = MenuItem::with_id(app, "quit", "Quit", true, None::<&str>)?;
            let about = MenuItem::with_id(app, "about", "About EZ Flow", true, None::<&str>)?;
            let menu = Menu::with_items(app, &[&about, &PredefinedMenuItem::separator(app)?, &quit])?;

            let _tray = TrayIconBuilder::new()
                .icon(app.default_window_icon().unwrap().clone())
                .menu(&menu)
                .on_menu_event(|app, event| {
                    match event.id.as_ref() {
                        "quit" => app.exit(0),
                        "about" => { /* show about */ }
                        _ => {}
                    }
                })
                .build(app)?;

            Ok(())
        })
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

### Tauri Configuration [Source: architecture.md#3]

Update `src-tauri/tauri.conf.json`:
```json
{
  "app": {
    "windows": [],
    "trayIcon": {
      "iconPath": "icons/tray-icon.png",
      "iconAsTemplate": true
    }
  }
}
```

### File Locations

| File | Purpose |
|------|---------|
| `src-tauri/src/services/tray.rs` | Tray service module |
| `src-tauri/icons/tray-icon.png` | Tray icon (32x32) |
| `src-tauri/icons/tray-icon@2x.png` | Retina tray icon (64x64) |

### Auto-Start Implementation

**Windows** - Use `auto-launch` crate or registry:
```rust
use winreg::RegKey;
use winreg::enums::*;

fn set_autostart_windows(enable: bool) -> Result<(), Box<dyn std::error::Error>> {
    let hkcu = RegKey::predef(HKEY_CURRENT_USER);
    let path = r"Software\Microsoft\Windows\CurrentVersion\Run";
    let key = hkcu.open_subkey_with_flags(path, KEY_WRITE)?;
    if enable {
        key.set_value("EZFlow", &std::env::current_exe()?.to_string_lossy().to_string())?;
    } else {
        let _ = key.delete_value("EZFlow");
    }
    Ok(())
}
```

**macOS** - Use LaunchAgent plist or `SMAppService`

**Linux** - Create `.desktop` file in `~/.config/autostart/`

### Testing

**Test File Location**: `src-tauri/src/services/tray.rs` (inline tests)

**Test Scenarios**:
- Menu items are created with correct IDs
- Quit event triggers app exit
- Tray icon loads without error

**Manual Testing**:
- Verify icon appears in system tray on each platform
- Verify menu opens on click
- Verify quit terminates process

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
