# Story 2.5: Settings Panel - Core Preferences

## Status

Ready for Review

## Story

**As a** user,
**I want** to customize hotkeys, model selection, and behavior,
**so that** EZ Flow works the way I prefer.

## Acceptance Criteria

1. Settings window opens from tray menu "Settings..."
2. Settings persist across app restarts (stored in app data directory)
3. Hotkey configuration with conflict detection and "Press to record" capture
4. Model selection dropdown showing downloaded models + download buttons
5. Startup behavior: "Start with system" toggle
6. Recording mode: "Push-to-talk" vs "Toggle" (press to start, press to stop)
7. Language selection for transcription (default: auto-detect)
8. Settings changes apply immediately (no restart required)

## Tasks / Subtasks

- [ ] **Task 1: Create Settings Window** (AC: 1)
  - [ ] Add "Settings..." menu item to tray
  - [ ] Create new Tauri window for settings
  - [ ] Create `src/routes/settings/+page.svelte`
  - [ ] Style with EZCorp design system

- [ ] **Task 2: Create Settings Data Model** (AC: 2)
  - [ ] Create `src-tauri/src/models/settings.rs`
  - [ ] Define `Settings` struct with all preferences
  - [ ] Implement Default trait
  - [ ] Add serialization with serde

- [ ] **Task 3: Implement Settings Persistence** (AC: 2)
  - [ ] Create `src-tauri/src/services/storage/settings.rs`
  - [ ] Save settings to JSON file in app data directory
  - [ ] Load settings on app startup
  - [ ] Handle missing/corrupt settings file gracefully

- [ ] **Task 4: Create Hotkey Configuration UI** (AC: 3)
  - [ ] Create `src/lib/components/HotkeyInput.svelte`
  - [ ] "Press to record" capture mode
  - [ ] Display current hotkey
  - [ ] Show conflict warning if hotkey in use
  - [ ] Validate hotkey format

- [ ] **Task 5: Create Model Selection UI** (AC: 4)
  - [ ] Create `src/lib/components/ModelSelector.svelte`
  - [ ] Show dropdown with downloaded models
  - [ ] Show download buttons for unavailable models
  - [ ] Display download progress inline
  - [ ] Indicate currently active model

- [ ] **Task 6: Implement Startup Behavior** (AC: 5)
  - [ ] Add "Start with system" toggle
  - [ ] Wire to auto-launch functionality (from Story 1.2)
  - [ ] Show platform-specific instructions if needed

- [ ] **Task 7: Implement Recording Mode Selection** (AC: 6)
  - [ ] Add radio buttons: "Push-to-talk" / "Toggle"
  - [ ] Save preference to settings
  - [ ] Update hotkey handler based on mode
  - [ ] Show description for each mode

- [ ] **Task 8: Implement Language Selection** (AC: 7)
  - [ ] Create language dropdown
  - [ ] Default option: "Auto-detect"
  - [ ] List common languages at top
  - [ ] Show all Whisper-supported languages

- [ ] **Task 9: Implement Immediate Apply** (AC: 8)
  - [ ] Watch for setting changes
  - [ ] Apply changes without restart
  - [ ] Re-register hotkeys when changed
  - [ ] Update model when changed

- [ ] **Task 10: Create Settings Store**
  - [ ] Create `src/lib/stores/settings.ts`
  - [ ] Load settings from backend
  - [ ] Sync changes to backend
  - [ ] Provide reactive access

- [ ] **Task 11: Add E2E Tests**
  - [ ] Test settings window opens
  - [ ] Test hotkey change persists
  - [ ] Test model selection
  - [ ] Test startup toggle

## Dev Notes

### Settings Data Model

```rust
// src-tauri/src/models/settings.rs
use serde::{Deserialize, Serialize};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Settings {
    pub hotkey: String,
    pub recording_mode: RecordingMode,
    pub model_id: String,
    pub language: Option<String>,  // None = auto-detect
    pub launch_at_login: bool,
    pub indicator_position: IndicatorPosition,
    pub auto_paste: bool,
    pub auto_copy: bool,
    pub injection_delay_ms: u32,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum RecordingMode {
    PushToTalk,
    Toggle,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum IndicatorPosition {
    Cursor,
    TopRight,
    BottomRight,
    Hidden,
}

impl Default for Settings {
    fn default() -> Self {
        Self {
            hotkey: if cfg!(target_os = "macos") {
                "Cmd+Shift+Space".into()
            } else {
                "Ctrl+Shift+Space".into()
            },
            recording_mode: RecordingMode::PushToTalk,
            model_id: "base".into(),
            language: None,
            launch_at_login: false,
            indicator_position: IndicatorPosition::TopRight,
            auto_paste: true,
            auto_copy: true,
            injection_delay_ms: 0,
        }
    }
}
```

### Settings Persistence

```rust
// src-tauri/src/services/storage/settings.rs
use directories::ProjectDirs;

pub fn get_settings_path() -> PathBuf {
    let proj_dirs = ProjectDirs::from("com", "ezflow", "EZFlow")
        .expect("Could not determine app directories");
    proj_dirs.config_dir().join("settings.json")
}

pub fn load_settings() -> Settings {
    let path = get_settings_path();
    if path.exists() {
        match std::fs::read_to_string(&path) {
            Ok(content) => serde_json::from_str(&content).unwrap_or_default(),
            Err(_) => Settings::default(),
        }
    } else {
        Settings::default()
    }
}

pub fn save_settings(settings: &Settings) -> Result<(), std::io::Error> {
    let path = get_settings_path();
    if let Some(parent) = path.parent() {
        std::fs::create_dir_all(parent)?;
    }
    let content = serde_json::to_string_pretty(settings)?;
    std::fs::write(path, content)
}
```

### Hotkey Input Component

```svelte
<!-- src/lib/components/HotkeyInput.svelte -->
<script lang="ts">
  import { createEventDispatcher } from 'svelte';

  export let value: string;
  export let conflict: boolean = false;

  let isCapturing = false;
  const dispatch = createEventDispatcher();

  function startCapture() {
    isCapturing = true;
  }

  function handleKeyDown(e: KeyboardEvent) {
    if (!isCapturing) return;
    e.preventDefault();

    const parts: string[] = [];
    if (e.metaKey) parts.push('Cmd');
    if (e.ctrlKey) parts.push('Ctrl');
    if (e.altKey) parts.push('Alt');
    if (e.shiftKey) parts.push('Shift');

    if (e.key !== 'Meta' && e.key !== 'Control' && e.key !== 'Alt' && e.key !== 'Shift') {
      parts.push(e.key.toUpperCase());
      const hotkey = parts.join('+');
      dispatch('change', hotkey);
      isCapturing = false;
    }
  }
</script>

<div class="flex items-center gap-2">
  <button
    class="px-4 py-2 bg-neutral-800 rounded border border-neutral-700 focus:border-yellow-400 min-w-[200px] text-left"
    class:border-red-500={conflict}
    on:click={startCapture}
    on:keydown={handleKeyDown}
  >
    {#if isCapturing}
      <span class="text-yellow-400">Press keys...</span>
    {:else}
      {value}
    {/if}
  </button>
  {#if conflict}
    <span class="text-red-400 text-sm">Hotkey in use</span>
  {/if}
</div>
```

### Settings Panel Layout

```svelte
<!-- src/routes/settings/+page.svelte -->
<script lang="ts">
  import { settings } from '$lib/stores/settings';
  import HotkeyInput from '$lib/components/HotkeyInput.svelte';
  import ModelSelector from '$lib/components/ModelSelector.svelte';
</script>

<div class="p-6 bg-neutral-900 min-h-screen">
  <h1 class="text-xl font-semibold mb-6">Settings</h1>

  <!-- Recording Section -->
  <section class="mb-8">
    <h2 class="text-lg font-medium mb-4 text-neutral-300">Recording</h2>

    <div class="space-y-4">
      <div>
        <label class="block text-sm text-neutral-400 mb-1">Hotkey</label>
        <HotkeyInput
          value={$settings.hotkey}
          on:change={(e) => settings.update('hotkey', e.detail)}
        />
      </div>

      <div>
        <label class="block text-sm text-neutral-400 mb-1">Recording Mode</label>
        <div class="flex gap-4">
          <label class="flex items-center gap-2">
            <input type="radio" bind:group={$settings.recording_mode} value="PushToTalk" />
            <span>Push-to-talk (hold to record)</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="radio" bind:group={$settings.recording_mode} value="Toggle" />
            <span>Toggle (press to start/stop)</span>
          </label>
        </div>
      </div>
    </div>
  </section>

  <!-- Transcription Section -->
  <section class="mb-8">
    <h2 class="text-lg font-medium mb-4 text-neutral-300">Transcription</h2>

    <div class="space-y-4">
      <div>
        <label class="block text-sm text-neutral-400 mb-1">Model</label>
        <ModelSelector />
      </div>

      <div>
        <label class="block text-sm text-neutral-400 mb-1">Language</label>
        <select bind:value={$settings.language} class="bg-neutral-800 rounded px-3 py-2">
          <option value={null}>Auto-detect</option>
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="zh">Chinese</option>
          <!-- More languages -->
        </select>
      </div>
    </div>
  </section>

  <!-- Behavior Section -->
  <section class="mb-8">
    <h2 class="text-lg font-medium mb-4 text-neutral-300">Behavior</h2>

    <div class="space-y-4">
      <label class="flex items-center gap-2">
        <input type="checkbox" bind:checked={$settings.launch_at_login} />
        <span>Start EZ Flow with system</span>
      </label>
    </div>
  </section>
</div>
```

### File Locations

| File | Purpose |
|------|---------|
| `src/routes/settings/+page.svelte` | Settings page |
| `src/lib/components/HotkeyInput.svelte` | Hotkey capture |
| `src/lib/components/ModelSelector.svelte` | Model dropdown |
| `src/lib/stores/settings.ts` | Settings store |
| `src-tauri/src/models/settings.rs` | Settings model |
| `src-tauri/src/services/storage/settings.rs` | Persistence |
| `src-tauri/src/commands/settings.rs` | Tauri commands |

### Testing

**E2E Tests**:
```typescript
test('should open settings from tray', async ({ page }) => {
  await page.click('[data-testid="tray-settings"]');
  await expect(page.locator('[data-testid="settings-panel"]')).toBeVisible();
});

test('should persist hotkey change', async ({ page }) => {
  await page.click('[data-testid="tray-settings"]');
  await page.click('[data-testid="hotkey-input"]');
  await page.keyboard.press('Control+Shift+H');

  // Reload and verify
  await page.reload();
  await expect(page.locator('[data-testid="hotkey-input"]')).toHaveText('Ctrl+Shift+H');
});
```

**Test IDs**:
```typescript
const testIds = {
  settingsPanel: 'settings-panel',
  hotkeyInput: 'hotkey-input',
  modelSelector: 'model-selector',
  languageSelector: 'language-selector',
  launchAtLoginToggle: 'launch-at-login-toggle',
  recordingModeRadio: 'recording-mode-radio',
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
