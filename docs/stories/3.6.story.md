# Story 3.6: Production Installers - Windows

## Status

Draft

## Story

**As a** Windows user,
**I want** a professional installer experience,
**so that** I can install and uninstall EZ Flow like any other application.

## Acceptance Criteria

1. NSIS or WiX installer generated via Tauri build
2. Installer includes: app files, VC++ runtime if needed, optional desktop shortcut
3. Uninstaller removes all app files (optional: keep settings/models)
4. Start menu entry created
5. Installer is code-signed (or documented how to sign)
6. Silent install option for enterprise deployment (`/S` flag)
7. Installer size < 20MB (excluding models)

## Tasks / Subtasks

- [ ] **Task 1: Configure NSIS Installer** (AC: 1)
  - [ ] Set up NSIS in tauri.conf.json
  - [ ] Configure installer options
  - [ ] Test basic installer generation

- [ ] **Task 2: Configure App Metadata** (AC: 4)
  - [ ] Set application name and version
  - [ ] Configure publisher info
  - [ ] Set product icon for installer

- [ ] **Task 3: Add Desktop Shortcut Option** (AC: 2)
  - [ ] Add checkbox for desktop shortcut
  - [ ] Default: checked
  - [ ] Create shortcut on install

- [ ] **Task 4: Create Start Menu Entry** (AC: 4)
  - [ ] Add Start Menu folder
  - [ ] Create program shortcut
  - [ ] Add uninstall shortcut

- [ ] **Task 5: Configure Uninstaller** (AC: 3)
  - [ ] Generate uninstaller
  - [ ] Remove all app files
  - [ ] Optional: prompt to keep settings/models
  - [ ] Remove Start Menu entries

- [ ] **Task 6: Handle VC++ Runtime** (AC: 2)
  - [ ] Check if VC++ runtime needed
  - [ ] Bundle or download on install
  - [ ] WebView2 usually handles this

- [ ] **Task 7: Implement Silent Install** (AC: 6)
  - [ ] Enable /S flag for silent install
  - [ ] Document silent install options
  - [ ] Test silent install/uninstall

- [ ] **Task 8: Configure Code Signing** (AC: 5)
  - [ ] Document code signing process
  - [ ] Set up signing in CI
  - [ ] Use EV certificate if available

- [ ] **Task 9: Optimize Installer Size** (AC: 7)
  - [ ] Minimize bundle size
  - [ ] Compress resources
  - [ ] Verify < 20MB without models

- [ ] **Task 10: Add Tests**
  - [ ] Test install/uninstall cycle
  - [ ] Test silent install
  - [ ] Verify shortcuts created

## Dev Notes

### Tauri NSIS Configuration

```json
// src-tauri/tauri.conf.json
{
  "bundle": {
    "active": true,
    "targets": ["nsis"],
    "windows": {
      "certificateThumbprint": null,
      "digestAlgorithm": "sha256",
      "timestampUrl": "http://timestamp.digicert.com"
    }
  },
  "nsis": {
    "template": null,
    "license": null,
    "headerImage": null,
    "sidebarImage": null,
    "installerIcon": null,
    "installMode": "currentUser",
    "languages": ["English"],
    "displayLanguageSelector": false,
    "compression": "lzma"
  }
}
```

### Custom NSIS Template (Optional)

If customization needed beyond Tauri defaults:

```nsi
; custom.nsi
!include "MUI2.nsh"

Name "EZ Flow"
OutFile "EZFlow-Setup.exe"
InstallDir "$LOCALAPPDATA\EZFlow"

; Pages
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

; Languages
!insertmacro MUI_LANGUAGE "English"

Section "Install"
  SetOutPath $INSTDIR
  File /r "dist\*.*"

  ; Create shortcuts
  CreateDirectory "$SMPROGRAMS\EZ Flow"
  CreateShortCut "$SMPROGRAMS\EZ Flow\EZ Flow.lnk" "$INSTDIR\EZFlow.exe"
  CreateShortCut "$SMPROGRAMS\EZ Flow\Uninstall.lnk" "$INSTDIR\Uninstall.exe"

  ${If} $DESKTOP_SHORTCUT == 1
    CreateShortCut "$DESKTOP\EZ Flow.lnk" "$INSTDIR\EZFlow.exe"
  ${EndIf}

  ; Create uninstaller
  WriteUninstaller "$INSTDIR\Uninstall.exe"
SectionEnd

Section "Uninstall"
  ; Remove files
  RMDir /r "$INSTDIR"

  ; Remove shortcuts
  Delete "$SMPROGRAMS\EZ Flow\*.*"
  RMDir "$SMPROGRAMS\EZ Flow"
  Delete "$DESKTOP\EZ Flow.lnk"
SectionEnd
```

### Code Signing in CI

```yaml
# .github/workflows/release.yml
- name: Sign Windows executable
  if: matrix.platform == 'windows-latest'
  env:
    WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
    WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
  run: |
    # Decode certificate
    echo $WINDOWS_CERTIFICATE | base64 --decode > certificate.pfx

    # Sign with signtool
    & 'C:\Program Files (x86)\Windows Kits\10\bin\10.0.22000.0\x64\signtool.exe' sign `
      /f certificate.pfx `
      /p $env:WINDOWS_CERTIFICATE_PASSWORD `
      /tr http://timestamp.digicert.com `
      /td sha256 `
      /fd sha256 `
      src-tauri/target/release/bundle/nsis/*.exe
```

### Silent Install Documentation

```markdown
## Silent Installation (Enterprise)

### Install
```cmd
EZFlow-Setup.exe /S
```

### Install to custom location
```cmd
EZFlow-Setup.exe /S /D=C:\Apps\EZFlow
```

### Uninstall silently
```cmd
"%LOCALAPPDATA%\EZFlow\Uninstall.exe" /S
```
```

### Bundle Size Optimization

- Use `strip` for release binaries
- Enable LTO in Cargo.toml
- Compress with LZMA in NSIS
- Don't bundle models with installer

```toml
# src-tauri/Cargo.toml
[profile.release]
strip = true
lto = true
opt-level = "z"
```

### File Locations

| File | Purpose |
|------|---------|
| `src-tauri/tauri.conf.json` | NSIS configuration |
| `src-tauri/nsis/custom.nsi` | Custom NSIS template (optional) |
| `.github/workflows/release.yml` | Build and sign |

### Testing

**Manual Testing Checklist**:
- [ ] Fresh install on Windows 10
- [ ] Fresh install on Windows 11
- [ ] Upgrade from previous version
- [ ] Uninstall completely
- [ ] Silent install works
- [ ] Desktop shortcut created
- [ ] Start menu entry created
- [ ] App runs after install
- [ ] No VC++ runtime errors

**Automated Tests**:
```powershell
# Test silent install
Start-Process -FilePath "EZFlow-Setup.exe" -ArgumentList "/S" -Wait
Test-Path "$env:LOCALAPPDATA\EZFlow\EZFlow.exe"

# Test app runs
Start-Process -FilePath "$env:LOCALAPPDATA\EZFlow\EZFlow.exe"
Start-Sleep -Seconds 5
Get-Process -Name "EZFlow" | Should -Not -BeNullOrEmpty
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
