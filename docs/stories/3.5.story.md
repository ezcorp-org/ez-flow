# Story 3.5: Auto-Update System

## Status

Ready

## Story

**As a** user,
**I want** EZ Flow to update itself automatically,
**so that** I always have the latest features and security fixes.

## Acceptance Criteria

1. Tauri's built-in updater configured with update server/GitHub Releases
2. Check for updates on app start (configurable interval)
3. Notification when update available: "Update available: v1.2.0 - Install now?"
4. Download and install with one click (restart required)
5. Release notes displayed before update
6. Settings toggle: "Check for updates automatically"
7. Manual "Check for Updates" option in tray menu
8. Signed updates for security (code signing per platform)

## Tasks / Subtasks

- [ ] **Task 1: Configure Tauri Updater Plugin** (AC: 1)
  - [ ] Add `@tauri-apps/plugin-updater` to dependencies
  - [ ] Configure plugin in `tauri.conf.json`
  - [ ] Set up update endpoint (GitHub Releases or custom server)

- [ ] **Task 2: Set Up GitHub Releases Endpoint** (AC: 1)
  - [ ] Configure release workflow
  - [ ] Generate update manifest JSON
  - [ ] Upload signed binaries

- [ ] **Task 3: Implement Update Check on Startup** (AC: 2)
  - [ ] Check for updates after app initialization
  - [ ] Respect user preference for auto-check
  - [ ] Configurable check interval

- [ ] **Task 4: Create Update Notification** (AC: 3)
  - [ ] Show system notification or in-app dialog
  - [ ] Display new version number
  - [ ] "Install Now" and "Later" options

- [ ] **Task 5: Implement One-Click Update** (AC: 4)
  - [ ] Download update in background
  - [ ] Show download progress
  - [ ] Install and restart app

- [ ] **Task 6: Display Release Notes** (AC: 5)
  - [ ] Fetch release notes from GitHub
  - [ ] Show in update dialog
  - [ ] Parse markdown for display

- [ ] **Task 7: Add Settings Toggle** (AC: 6)
  - [ ] Add `auto_check_updates` to Settings
  - [ ] Default: true
  - [ ] Update UI in Settings panel

- [ ] **Task 8: Add Manual Check in Tray** (AC: 7)
  - [ ] Add "Check for Updates" menu item
  - [ ] Show result (up-to-date or update available)
  - [ ] Handle errors gracefully

- [ ] **Task 9: Configure Code Signing** (AC: 8)
  - [ ] Set up signing keys in CI secrets
  - [ ] Windows: Code signing certificate
  - [ ] macOS: Apple Developer ID
  - [ ] Verify signature during update

- [ ] **Task 10: Add Tests**
  - [ ] Test update check logic
  - [ ] Test version comparison
  - [ ] Mock update server for testing

## Dev Notes

### Tauri Updater Configuration [Source: architecture.md#10.4]

```json
// src-tauri/tauri.conf.json
{
  "plugins": {
    "updater": {
      "endpoints": [
        "https://github.com/your-org/ez-flow/releases/latest/download/latest.json"
      ],
      "pubkey": "YOUR_PUBLIC_KEY_HERE"
    }
  }
}
```

### Generate Update Keys

```bash
# Generate signing keys
tauri signer generate -w ~/.tauri/myapp.key

# Public key goes in tauri.conf.json
# Private key used in CI for signing
```

### Update Manifest Format

```json
// latest.json (uploaded with each release)
{
  "version": "1.2.0",
  "notes": "Bug fixes and performance improvements",
  "pub_date": "2024-01-15T00:00:00Z",
  "platforms": {
    "darwin-aarch64": {
      "signature": "...",
      "url": "https://github.com/.../EZFlow_1.2.0_aarch64.app.tar.gz"
    },
    "darwin-x86_64": {
      "signature": "...",
      "url": "https://github.com/.../EZFlow_1.2.0_x64.app.tar.gz"
    },
    "linux-x86_64": {
      "signature": "...",
      "url": "https://github.com/.../EZFlow_1.2.0_amd64.AppImage.tar.gz"
    },
    "windows-x86_64": {
      "signature": "...",
      "url": "https://github.com/.../EZFlow_1.2.0_x64-setup.nsis.zip"
    }
  }
}
```

### Update Check Implementation

```typescript
// src/lib/services/updater.ts
import { check } from '@tauri-apps/plugin-updater';
import { relaunch } from '@tauri-apps/plugin-process';

export async function checkForUpdates(): Promise<UpdateInfo | null> {
  try {
    const update = await check();

    if (update?.available) {
      return {
        version: update.version,
        notes: update.body,
        date: update.date,
      };
    }

    return null;
  } catch (e) {
    console.error('Update check failed:', e);
    return null;
  }
}

export async function downloadAndInstall(): Promise<void> {
  const update = await check();

  if (update?.available) {
    await update.downloadAndInstall((progress) => {
      console.log(`Download progress: ${progress.downloaded}/${progress.total}`);
    });

    // Restart to apply update
    await relaunch();
  }
}
```

### Update Dialog Component

```svelte
<!-- src/lib/components/UpdateDialog.svelte -->
<script lang="ts">
  import { createEventDispatcher } from 'svelte';
  import { downloadAndInstall } from '$lib/services/updater';

  export let version: string;
  export let notes: string;

  const dispatch = createEventDispatcher();

  let downloading = false;
  let progress = 0;

  async function install() {
    downloading = true;
    await downloadAndInstall();
  }
</script>

<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-neutral-900 rounded-lg p-6 max-w-md w-full mx-4">
    <h2 class="text-xl font-bold mb-4">Update Available</h2>

    <p class="text-neutral-300 mb-4">
      Version {version} is available. You're currently on version {currentVersion}.
    </p>

    {#if notes}
      <div class="bg-neutral-800 rounded p-3 mb-4 max-h-32 overflow-y-auto">
        <h3 class="text-sm font-medium text-neutral-400 mb-2">What's New</h3>
        <p class="text-sm text-neutral-300">{notes}</p>
      </div>
    {/if}

    {#if downloading}
      <div class="mb-4">
        <div class="h-2 bg-neutral-700 rounded-full overflow-hidden">
          <div class="h-full bg-yellow-400 transition-all" style="width: {progress}%"></div>
        </div>
        <p class="text-sm text-neutral-400 mt-2">Downloading update...</p>
      </div>
    {:else}
      <div class="flex gap-3">
        <button
          class="flex-1 px-4 py-2 bg-yellow-400 text-black rounded font-medium"
          on:click={install}
        >
          Install & Restart
        </button>
        <button
          class="px-4 py-2 bg-neutral-800 rounded"
          on:click={() => dispatch('dismiss')}
        >
          Later
        </button>
      </div>
    {/if}
  </div>
</div>
```

### CI Release Workflow

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ${{ matrix.platform }}
    strategy:
      matrix:
        include:
          - platform: windows-latest
          - platform: macos-latest
          - platform: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: 'EZ Flow v__VERSION__'
          releaseBody: 'See the changelog for details.'
          releaseDraft: true
          prerelease: false
```

### Settings Model Update

```rust
// src-tauri/src/models/settings.rs
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Settings {
    // ... existing fields

    #[serde(default = "default_true")]
    pub auto_check_updates: bool,

    #[serde(default)]
    pub last_update_check: Option<String>,
}

fn default_true() -> bool {
    true
}
```

### File Locations

| File | Purpose |
|------|---------|
| `src-tauri/tauri.conf.json` | Updater configuration |
| `src/lib/services/updater.ts` | Update service |
| `src/lib/components/UpdateDialog.svelte` | Update UI |
| `.github/workflows/release.yml` | Release workflow |

### Testing

**Test Scenarios**:
- `test_version_comparison` - Newer version detected
- `test_no_update_available` - Already on latest
- `test_update_check_disabled` - Respects setting

**Manual Testing**:
- Test update flow on each platform
- Verify signature validation
- Test rollback if update fails

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
