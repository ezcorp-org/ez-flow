# Story 3.8: Production Installers - Linux

## Status

Draft

## Story

**As a** Linux user,
**I want** flexible installation options,
**so that** I can install EZ Flow on my distribution of choice.

## Acceptance Criteria

1. AppImage build (universal, no install required)
2. `.deb` package for Debian/Ubuntu
3. Flatpak manifest for Flathub submission (stretch goal)
4. Desktop entry and icon installed correctly
5. Proper handling of Linux audio systems (PulseAudio/PipeWire)
6. Wayland support tested (text injection via `ydotool`)
7. Documentation for building from source

## Tasks / Subtasks

- [ ] **Task 1: Configure AppImage Build** (AC: 1)
  - [ ] Set up AppImage in tauri.conf.json
  - [ ] Bundle all dependencies
  - [ ] Test on multiple distros

- [ ] **Task 2: Configure .deb Package** (AC: 2)
  - [ ] Set up deb bundle in Tauri
  - [ ] Configure package metadata
  - [ ] Set dependencies

- [ ] **Task 3: Create Desktop Entry** (AC: 4)
  - [ ] Create .desktop file
  - [ ] Set icon paths
  - [ ] Configure categories

- [ ] **Task 4: Handle Audio Systems** (AC: 5)
  - [ ] Test with PulseAudio
  - [ ] Test with PipeWire
  - [ ] Document audio requirements

- [ ] **Task 5: Test Wayland Support** (AC: 6)
  - [ ] Verify app runs on Wayland
  - [ ] Test ydotool for text injection
  - [ ] Document Wayland limitations

- [ ] **Task 6: Create Flatpak Manifest** (AC: 3)
  - [ ] Create manifest YAML
  - [ ] Configure runtime and SDK
  - [ ] Test local build

- [ ] **Task 7: Write Build Documentation** (AC: 7)
  - [ ] Document build dependencies
  - [ ] Provide step-by-step instructions
  - [ ] Test on clean Ubuntu install

- [ ] **Task 8: Add Tests**
  - [ ] Test AppImage on Ubuntu
  - [ ] Test deb install/remove
  - [ ] Test on Fedora/Arch

## Dev Notes

### Tauri Linux Configuration

```json
// src-tauri/tauri.conf.json
{
  "bundle": {
    "active": true,
    "targets": ["appimage", "deb"],
    "linux": {
      "deb": {
        "depends": [
          "libwebkit2gtk-4.1-0",
          "libgtk-3-0",
          "libasound2"
        ],
        "section": "utils",
        "priority": "optional"
      }
    }
  }
}
```

### Desktop Entry

```ini
# Generated automatically, but verify:
[Desktop Entry]
Name=EZ Flow
Comment=Local speech-to-text transcription
Exec=ezflow
Icon=com.ezflow.app
Terminal=false
Type=Application
Categories=Utility;Accessibility;
Keywords=speech;transcription;dictation;whisper;
MimeType=audio/wav;audio/mp3;audio/ogg;audio/flac;
StartupWMClass=ezflow
```

### AppImage Testing Script

```bash
#!/bin/bash
# test-appimage.sh

APPIMAGE="EZFlow-x86_64.AppImage"

echo "Testing AppImage..."

# Make executable
chmod +x $APPIMAGE

# Test launch
./$APPIMAGE &
PID=$!
sleep 5

# Check if running
if ps -p $PID > /dev/null; then
    echo "✓ AppImage launches successfully"
    kill $PID
else
    echo "✗ AppImage failed to launch"
    exit 1
fi

# Test with different GLIBC versions
echo "Testing compatibility..."
# Use docker to test on older systems
```

### Flatpak Manifest

```yaml
# com.ezflow.app.yaml
app-id: com.ezflow.app
runtime: org.gnome.Platform
runtime-version: '45'
sdk: org.gnome.Sdk
command: ezflow

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --share=ipc
  - --device=dri
  # For ydotool on Wayland
  - --socket=system-bus

modules:
  - name: ezflow
    buildsystem: simple
    build-commands:
      - install -Dm755 ezflow -t /app/bin/
      - install -Dm644 com.ezflow.app.desktop -t /app/share/applications/
      - install -Dm644 com.ezflow.app.svg -t /app/share/icons/hicolor/scalable/apps/
    sources:
      - type: archive
        url: https://github.com/your-org/ez-flow/releases/download/v1.0.0/ezflow-linux.tar.gz
        sha256: ...
```

### Audio System Detection

```rust
// src-tauri/src/services/audio/linux.rs

pub fn detect_audio_system() -> AudioSystem {
    // Check for PipeWire first (newer systems)
    if std::env::var("PIPEWIRE_RUNTIME_DIR").is_ok() {
        return AudioSystem::PipeWire;
    }

    // Check for PulseAudio
    if std::env::var("PULSE_SERVER").is_ok() ||
       std::path::Path::new("/run/user/1000/pulse").exists() {
        return AudioSystem::PulseAudio;
    }

    // Fallback to ALSA
    AudioSystem::Alsa
}

#[derive(Debug)]
pub enum AudioSystem {
    PipeWire,
    PulseAudio,
    Alsa,
}
```

### Wayland Text Injection

```rust
// src-tauri/src/services/platform/linux.rs

impl LinuxTextInjector {
    pub fn inject_wayland(&self, text: &str) -> Result<(), PlatformError> {
        // Check for ydotool
        let ydotool_available = which::which("ydotool").is_ok();

        if !ydotool_available {
            return Err(PlatformError::MissingDependency(
                "ydotool is required for Wayland text injection. Install with: sudo apt install ydotool".into()
            ));
        }

        // Copy to clipboard
        std::process::Command::new("wl-copy")
            .arg(text)
            .status()?;

        // Simulate Ctrl+V
        // ydotool keycodes: 29=Ctrl, 47=V
        std::process::Command::new("ydotool")
            .args(["key", "29:1", "47:1", "47:0", "29:0"])
            .status()?;

        Ok(())
    }
}
```

### Build from Source Documentation

```markdown
# Building EZ Flow from Source (Linux)

## Prerequisites

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y \
  build-essential \
  curl \
  wget \
  libwebkit2gtk-4.1-dev \
  libgtk-3-dev \
  libayatana-appindicator3-dev \
  librsvg2-dev \
  patchelf \
  libasound2-dev \
  libssl-dev \
  pkg-config

# Install Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Install Bun
curl -fsSL https://bun.sh/install | bash
```

## Build Steps

```bash
# Clone repository
git clone https://github.com/your-org/ez-flow.git
cd ez-flow

# Install dependencies
bun install

# Build release
bun tauri build

# Output in:
# - src-tauri/target/release/bundle/appimage/
# - src-tauri/target/release/bundle/deb/
```
```

### File Locations

| File | Purpose |
|------|---------|
| `src-tauri/tauri.conf.json` | Linux bundle config |
| `flatpak/com.ezflow.app.yaml` | Flatpak manifest |
| `docs/building.md` | Build documentation |

### Testing

**Distro Testing Matrix**:

| Distro | Version | X11 | Wayland | Audio |
|--------|---------|-----|---------|-------|
| Ubuntu | 22.04 | | | |
| Ubuntu | 24.04 | | | |
| Fedora | 39 | | | |
| Arch | Latest | | | |
| Debian | 12 | | | |

**Test Commands**:
```bash
# Test AppImage
./EZFlow.AppImage

# Test deb
sudo dpkg -i ezflow_1.0.0_amd64.deb
ezflow

# Test uninstall
sudo apt remove ezflow

# Test Wayland
WAYLAND_DISPLAY=wayland-0 ./EZFlow.AppImage
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
