# Story 2.6: Settings Panel - Advanced Options

## Status

Ready for Review

## Story

**As a** developer/power user,
**I want** access to advanced configuration options,
**so that** I can fine-tune EZ Flow for my specific needs.

## Acceptance Criteria

1. Advanced section in Settings (collapsed by default)
2. Text injection delay slider (0-50ms between keystrokes)
3. Recording indicator position selector
4. Audio format preferences (sample rate, if hardware supports)
5. Model file location (custom path option)
6. Debug logging toggle (writes to log file)
7. "Reset to Defaults" button with confirmation
8. Export/Import settings as JSON file

## Tasks / Subtasks

- [ ] **Task 1: Create Collapsible Advanced Section** (AC: 1)
  - [ ] Add "Advanced" section header
  - [ ] Implement collapse/expand toggle
  - [ ] Collapsed by default
  - [ ] Remember collapsed state

- [ ] **Task 2: Text Injection Delay Slider** (AC: 2)
  - [ ] Add slider input 0-50ms
  - [ ] Show current value
  - [ ] Update setting on change
  - [ ] Tooltip explaining use case

- [ ] **Task 3: Indicator Position Selector** (AC: 3)
  - [ ] Add dropdown for position options
  - [ ] Options: Near cursor, Top-right, Bottom-right, Hidden
  - [ ] Preview position on change
  - [ ] Wire to IndicatorPosition setting

- [ ] **Task 4: Audio Format Preferences** (AC: 4)
  - [ ] Query available sample rates from cpal
  - [ ] Show dropdown with supported rates
  - [ ] Default: device default
  - [ ] Display current input device

- [ ] **Task 5: Custom Model Path** (AC: 5)
  - [ ] Add text input for custom path
  - [ ] Add browse button for folder selection
  - [ ] Validate path exists
  - [ ] Show current model directory

- [ ] **Task 6: Debug Logging Toggle** (AC: 6)
  - [ ] Add toggle for debug logging
  - [ ] Configure tracing subscriber when enabled
  - [ ] Show log file location
  - [ ] Add "Open Log File" button

- [ ] **Task 7: Reset to Defaults** (AC: 7)
  - [ ] Add "Reset to Defaults" button
  - [ ] Show confirmation dialog
  - [ ] Reset all settings to default values
  - [ ] Re-apply default hotkey

- [ ] **Task 8: Export Settings** (AC: 8)
  - [ ] Add "Export Settings" button
  - [ ] Use save file dialog
  - [ ] Export as formatted JSON
  - [ ] Include version for compatibility

- [ ] **Task 9: Import Settings** (AC: 8)
  - [ ] Add "Import Settings" button
  - [ ] Use open file dialog
  - [ ] Validate JSON structure
  - [ ] Apply imported settings
  - [ ] Show success/error message

- [ ] **Task 10: Update Settings Model**
  - [ ] Add advanced fields to Settings struct
  - [ ] Ensure backward compatibility on load
  - [ ] Add migration for old settings files

- [ ] **Task 11: Add E2E Tests**
  - [ ] Test advanced section toggle
  - [ ] Test export/import roundtrip
  - [ ] Test reset to defaults

## Dev Notes

### Extended Settings Model

```rust
// src-tauri/src/models/settings.rs - Extended fields
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Settings {
    // Core settings from Story 2.5
    pub hotkey: String,
    pub recording_mode: RecordingMode,
    pub model_id: String,
    pub language: Option<String>,
    pub launch_at_login: bool,
    pub indicator_position: IndicatorPosition,
    pub auto_paste: bool,
    pub auto_copy: bool,

    // Advanced settings
    pub injection_delay_ms: u32,
    pub custom_model_path: Option<PathBuf>,
    pub sample_rate: Option<u32>,  // None = device default
    pub debug_logging: bool,
    pub log_file_path: Option<PathBuf>,

    // Metadata
    #[serde(default = "default_version")]
    pub version: String,
}

fn default_version() -> String {
    "1.0".into()
}
```

### Advanced Section Component

```svelte
<!-- src/lib/components/AdvancedSettings.svelte -->
<script lang="ts">
  import { settings } from '$lib/stores/settings';
  import { open, save } from '@tauri-apps/plugin-dialog';
  import { invoke } from '@tauri-apps/api/core';

  let isExpanded = false;

  async function exportSettings() {
    const path = await save({
      title: 'Export Settings',
      filters: [{ name: 'JSON', extensions: ['json'] }],
      defaultPath: 'ezflow-settings.json',
    });

    if (path) {
      await invoke('export_settings', { path });
    }
  }

  async function importSettings() {
    const path = await open({
      title: 'Import Settings',
      filters: [{ name: 'JSON', extensions: ['json'] }],
    });

    if (path) {
      try {
        await invoke('import_settings', { path });
        // Refresh settings store
        settings.refresh();
      } catch (e) {
        alert(`Import failed: ${e}`);
      }
    }
  }

  async function resetToDefaults() {
    if (confirm('Reset all settings to defaults? This cannot be undone.')) {
      await invoke('reset_settings');
      settings.refresh();
    }
  }
</script>

<section class="border-t border-neutral-800 mt-6 pt-6">
  <button
    class="flex items-center justify-between w-full text-left"
    on:click={() => isExpanded = !isExpanded}
  >
    <h2 class="text-lg font-medium text-neutral-300">Advanced</h2>
    <span class="text-neutral-500">{isExpanded ? '▼' : '▶'}</span>
  </button>

  {#if isExpanded}
    <div class="mt-4 space-y-6">
      <!-- Injection Delay -->
      <div>
        <label class="block text-sm text-neutral-400 mb-1">
          Text Injection Delay: {$settings.injection_delay_ms}ms
        </label>
        <input
          type="range"
          min="0"
          max="50"
          bind:value={$settings.injection_delay_ms}
          class="w-full"
        />
        <p class="text-xs text-neutral-500 mt-1">
          Increase if text appears garbled in some applications
        </p>
      </div>

      <!-- Indicator Position -->
      <div>
        <label class="block text-sm text-neutral-400 mb-1">Recording Indicator Position</label>
        <select bind:value={$settings.indicator_position} class="bg-neutral-800 rounded px-3 py-2 w-full">
          <option value="Cursor">Near cursor</option>
          <option value="TopRight">Top right</option>
          <option value="BottomRight">Bottom right</option>
          <option value="Hidden">Hidden</option>
        </select>
      </div>

      <!-- Custom Model Path -->
      <div>
        <label class="block text-sm text-neutral-400 mb-1">Model Directory</label>
        <div class="flex gap-2">
          <input
            type="text"
            bind:value={$settings.custom_model_path}
            placeholder="Default location"
            class="flex-1 bg-neutral-800 rounded px-3 py-2"
          />
          <button class="px-3 py-2 bg-neutral-700 rounded" on:click={browseModelPath}>
            Browse
          </button>
        </div>
      </div>

      <!-- Debug Logging -->
      <div>
        <label class="flex items-center gap-2">
          <input type="checkbox" bind:checked={$settings.debug_logging} />
          <span>Enable debug logging</span>
        </label>
        {#if $settings.debug_logging}
          <p class="text-xs text-neutral-500 mt-1">
            Log file: {$settings.log_file_path || 'Default location'}
          </p>
        {/if}
      </div>

      <!-- Export/Import/Reset -->
      <div class="flex gap-2 pt-4 border-t border-neutral-800">
        <button
          class="px-4 py-2 bg-neutral-800 rounded hover:bg-neutral-700"
          on:click={exportSettings}
        >
          Export Settings
        </button>
        <button
          class="px-4 py-2 bg-neutral-800 rounded hover:bg-neutral-700"
          on:click={importSettings}
        >
          Import Settings
        </button>
        <button
          class="px-4 py-2 bg-red-900/50 text-red-400 rounded hover:bg-red-900"
          on:click={resetToDefaults}
        >
          Reset to Defaults
        </button>
      </div>
    </div>
  {/if}
</section>
```

### Tauri Commands for Import/Export

```rust
// src-tauri/src/commands/settings.rs

#[tauri::command]
pub async fn export_settings(
    path: String,
    state: State<'_, AppState>,
) -> Result<(), String> {
    let settings = state.settings.read().await;
    let content = serde_json::to_string_pretty(&*settings)
        .map_err(|e| e.to_string())?;
    std::fs::write(&path, content).map_err(|e| e.to_string())?;
    Ok(())
}

#[tauri::command]
pub async fn import_settings(
    path: String,
    state: State<'_, AppState>,
) -> Result<(), String> {
    let content = std::fs::read_to_string(&path)
        .map_err(|e| e.to_string())?;
    let imported: Settings = serde_json::from_str(&content)
        .map_err(|e| format!("Invalid settings file: {}", e))?;

    let mut settings = state.settings.write().await;
    *settings = imported;
    settings.save().map_err(|e| e.to_string())?;

    // Re-apply settings that need runtime changes
    // (e.g., re-register hotkey)
    Ok(())
}

#[tauri::command]
pub async fn reset_settings(
    state: State<'_, AppState>,
) -> Result<(), String> {
    let mut settings = state.settings.write().await;
    *settings = Settings::default();
    settings.save().map_err(|e| e.to_string())?;
    Ok(())
}
```

### Debug Logging Configuration

```rust
// src-tauri/src/services/logging.rs
use tracing_appender::rolling::{RollingFileAppender, Rotation};
use tracing_subscriber::{fmt, prelude::*, EnvFilter};

pub fn init_logging(debug_enabled: bool) {
    let filter = if debug_enabled {
        EnvFilter::new("ez_flow=debug,tauri=info")
    } else {
        EnvFilter::new("ez_flow=info,tauri=warn")
    };

    if debug_enabled {
        let log_dir = get_log_directory();
        let file_appender = RollingFileAppender::new(
            Rotation::DAILY,
            log_dir,
            "ez-flow.log",
        );

        tracing_subscriber::registry()
            .with(fmt::layer().with_writer(file_appender))
            .with(filter)
            .init();
    } else {
        tracing_subscriber::registry()
            .with(fmt::layer())
            .with(filter)
            .init();
    }
}
```

### File Locations

| File | Purpose |
|------|---------|
| `src/lib/components/AdvancedSettings.svelte` | Advanced settings UI |
| `src-tauri/src/commands/settings.rs` | Import/Export commands |
| `src-tauri/src/services/logging.rs` | Debug logging config |

### Testing

**E2E Tests**:
```typescript
test('export and import settings', async ({ page }) => {
  await page.click('[data-testid="settings-advanced-toggle"]');

  // Change a setting
  await page.fill('[data-testid="injection-delay-slider"]', '25');

  // Export
  await page.click('[data-testid="export-settings"]');
  // Handle file dialog...

  // Reset
  await page.click('[data-testid="reset-defaults"]');
  await page.click('[data-testid="confirm-reset"]');

  // Verify reset
  await expect(page.locator('[data-testid="injection-delay-slider"]')).toHaveValue('0');

  // Import
  await page.click('[data-testid="import-settings"]');
  // Handle file dialog...

  // Verify imported
  await expect(page.locator('[data-testid="injection-delay-slider"]')).toHaveValue('25');
});
```

**Test IDs**:
```typescript
const testIds = {
  advancedSettingsToggle: 'settings-advanced-toggle',
  injectionDelaySlider: 'injection-delay-slider',
  indicatorPositionSelect: 'indicator-position-select',
  modelPathInput: 'model-path-input',
  debugLoggingToggle: 'debug-logging-toggle',
  exportSettingsBtn: 'export-settings',
  importSettingsBtn: 'import-settings',
  resetDefaultsBtn: 'reset-defaults',
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
