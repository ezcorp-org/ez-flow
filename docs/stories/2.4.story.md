# Story 2.4: Recording Indicator Widget

## Status

Ready for Review

## Story

**As a** user,
**I want** a visual indicator when I'm recording,
**so that** I know EZ Flow is listening and when to stop speaking.

## Acceptance Criteria

1. Small floating pill/badge appears near cursor or corner when recording
2. Indicator shows: recording icon/waveform animation, elapsed time
3. Indicator is always-on-top and semi-transparent (non-intrusive)
4. Position configurable: near cursor, top-right, bottom-right, or hidden
5. Indicator disappears when recording stops
6. Shows brief "Transcribing..." state while Whisper processes
7. Keyboard accessible: can be dismissed without mouse

## Tasks / Subtasks

- [ ] **Task 1: Create Recording Indicator Window** (AC: 1, 3)
  - [ ] Create new Tauri window for indicator
  - [ ] Configure as always-on-top, frameless, transparent
  - [ ] Set small fixed size (e.g., 200x48)
  - [ ] Configure to skip taskbar

- [ ] **Task 2: Create Indicator Component** (AC: 1, 2)
  - [ ] Create `src/lib/components/RecordingIndicator.svelte`
  - [ ] Display recording dot (pulsing animation)
  - [ ] Display waveform visualization (audio level)
  - [ ] Display elapsed time (MM:SS format)

- [ ] **Task 3: Implement Waveform Animation** (AC: 2)
  - [ ] Create `src/lib/components/AudioVisualizer.svelte`
  - [ ] Receive audio level data from backend
  - [ ] Render simple bars or line visualization
  - [ ] Animate based on input levels

- [ ] **Task 4: Implement Elapsed Time Display** (AC: 2)
  - [ ] Track recording start time
  - [ ] Update display every second
  - [ ] Format as MM:SS
  - [ ] Stop timer on recording end

- [ ] **Task 5: Implement Position Configuration** (AC: 4)
  - [ ] Add `indicator_position` to Settings
  - [ ] Options: cursor, top-right, bottom-right, hidden
  - [ ] Update window position based on setting
  - [ ] For cursor position: follow mouse on recording start

- [ ] **Task 6: Show/Hide Window on Recording State** (AC: 5)
  - [ ] Listen for recording state changes
  - [ ] Show window on recording start
  - [ ] Hide window on recording stop (after transcribing state)
  - [ ] Use Tauri window.show() and window.hide()

- [ ] **Task 7: Implement Transcribing State** (AC: 6)
  - [ ] Change display when transcribing starts
  - [ ] Show "Transcribing..." text
  - [ ] Show spinner or progress indicator
  - [ ] Hide after transcription complete

- [ ] **Task 8: Implement Keyboard Dismissal** (AC: 7)
  - [ ] Listen for Escape key
  - [ ] Cancel recording on Escape
  - [ ] Hide indicator
  - [ ] Focus should not leave current app

- [ ] **Task 9: Style with EZCorp Design System**
  - [ ] Use dark background (#0A0A0A with opacity)
  - [ ] Yellow accent (#F4C430) for recording dot
  - [ ] Smooth animations (200ms transitions)
  - [ ] Rounded corners (8px)

- [ ] **Task 10: Add E2E Tests**
  - [ ] Test indicator appears on recording
  - [ ] Test indicator disappears after transcription
  - [ ] Test position settings

## Dev Notes

### Tauri Window Configuration

```json
// src-tauri/tauri.conf.json
{
  "app": {
    "windows": [
      {
        "label": "recording-indicator",
        "title": "Recording",
        "width": 200,
        "height": 48,
        "resizable": false,
        "decorations": false,
        "alwaysOnTop": true,
        "transparent": true,
        "skipTaskbar": true,
        "visible": false,
        "url": "/indicator"
      }
    ]
  }
}
```

### Recording Indicator Component

```svelte
<!-- src/lib/components/RecordingIndicator.svelte -->
<script lang="ts">
  import { onMount, onDestroy } from 'svelte';
  import AudioVisualizer from './AudioVisualizer.svelte';

  export let isRecording = false;
  export let isTranscribing = false;
  export let audioLevel = 0;

  let elapsed = 0;
  let interval: ReturnType<typeof setInterval>;

  $: if (isRecording && !interval) {
    elapsed = 0;
    interval = setInterval(() => elapsed++, 1000);
  } else if (!isRecording && interval) {
    clearInterval(interval);
    interval = undefined;
  }

  function formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  onDestroy(() => {
    if (interval) clearInterval(interval);
  });
</script>

<div class="recording-indicator bg-neutral-900/90 backdrop-blur rounded-lg px-4 py-2 flex items-center gap-3">
  {#if isTranscribing}
    <div class="w-3 h-3 rounded-full bg-blue-400 animate-pulse"></div>
    <span class="text-sm text-neutral-300">Transcribing...</span>
  {:else if isRecording}
    <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
    <AudioVisualizer level={audioLevel} />
    <span class="text-sm text-neutral-300 font-mono">{formatTime(elapsed)}</span>
  {/if}
</div>

<style>
  .recording-indicator {
    -webkit-app-region: drag;
  }
</style>
```

### Audio Visualizer Component

```svelte
<!-- src/lib/components/AudioVisualizer.svelte -->
<script lang="ts">
  export let level: number = 0; // 0-1

  const bars = 5;

  function getBarHeight(index: number, level: number): number {
    const normalized = Math.min(1, Math.max(0, level));
    const baseHeight = 4;
    const maxHeight = 16;
    const threshold = (index + 1) / bars;
    return normalized >= threshold ? maxHeight : baseHeight + (normalized / threshold) * (maxHeight - baseHeight);
  }
</script>

<div class="flex items-center gap-0.5 h-4">
  {#each Array(bars) as _, i}
    <div
      class="w-1 bg-yellow-400 rounded-full transition-all duration-100"
      style="height: {getBarHeight(i, level)}px"
    ></div>
  {/each}
</div>
```

### Window Position Logic

```rust
// src-tauri/src/services/ui/indicator.rs
use tauri::{LogicalPosition, Manager, Window};

pub fn position_indicator_window(
    window: &Window,
    position: IndicatorPosition,
) -> Result<(), tauri::Error> {
    match position {
        IndicatorPosition::TopRight => {
            let monitor = window.current_monitor()?.unwrap();
            let size = monitor.size();
            window.set_position(LogicalPosition::new(
                size.width as f64 - 220.0,
                20.0
            ))?;
        }
        IndicatorPosition::BottomRight => {
            let monitor = window.current_monitor()?.unwrap();
            let size = monitor.size();
            window.set_position(LogicalPosition::new(
                size.width as f64 - 220.0,
                size.height as f64 - 68.0
            ))?;
        }
        IndicatorPosition::Cursor => {
            // Get cursor position and offset slightly
            if let Ok(pos) = window.cursor_position() {
                window.set_position(LogicalPosition::new(
                    pos.x + 20.0,
                    pos.y + 20.0
                ))?;
            }
        }
        IndicatorPosition::Hidden => {
            // Don't show window at all
        }
    }
    Ok(())
}
```

### Audio Level Events

```rust
// Emit audio level during recording
fn emit_audio_level(window: &Window, samples: &[f32]) {
    let rms = (samples.iter().map(|s| s * s).sum::<f32>() / samples.len() as f32).sqrt();
    let level = (rms * 10.0).min(1.0); // Normalize to 0-1

    let _ = window.emit("recording:level", level);
}
```

### File Locations

| File | Purpose |
|------|---------|
| `src/lib/components/RecordingIndicator.svelte` | Main indicator |
| `src/lib/components/AudioVisualizer.svelte` | Waveform bars |
| `src/routes/indicator/+page.svelte` | Indicator window page |
| `src-tauri/src/services/ui/indicator.rs` | Window management |

### EZCorp Design Tokens [Source: front-end-spec.md]

```css
/* Indicator specific styles */
.recording-indicator {
  background: rgba(10, 10, 10, 0.9);
  backdrop-filter: blur(8px);
  border-radius: 8px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
}

/* Recording dot pulse animation */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.animate-pulse {
  animation: pulse 1s ease-in-out infinite;
}
```

### Testing

**E2E Tests**:
```typescript
test('recording indicator appears during recording', async ({ page }) => {
  // Start recording
  await page.click('[data-testid="start-recording"]');

  // Check indicator window is visible
  const indicator = page.locator('[data-testid="recording-indicator"]');
  await expect(indicator).toBeVisible();

  // Check timer is running
  await page.waitForTimeout(2000);
  await expect(indicator.locator('[data-testid="elapsed-time"]')).toHaveText(/00:0[12]/);

  // Stop recording
  await page.click('[data-testid="stop-recording"]');

  // Check transcribing state
  await expect(indicator).toContainText('Transcribing');

  // Check indicator disappears
  await expect(indicator).not.toBeVisible({ timeout: 5000 });
});
```

**Test IDs**:
```typescript
const testIds = {
  recordingIndicator: 'recording-indicator',
  recordingDot: 'recording-dot',
  audioVisualizer: 'audio-visualizer',
  elapsedTime: 'elapsed-time',
  transcribingState: 'transcribing-state',
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
