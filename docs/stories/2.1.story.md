# Story 2.1: Global Hotkey Registration

## Status

Ready for Review

## Story

**As a** user,
**I want** to trigger recording with a keyboard shortcut from any application,
**so that** I can start dictating without switching windows.

## Acceptance Criteria

1. Global hotkey registration using `tauri-plugin-global-shortcut` or platform APIs
2. Default hotkey: `Ctrl+Shift+Space` (Windows/Linux), `Cmd+Shift+Space` (macOS)
3. Hotkey works when EZ Flow is in background (any app focused)
4. Hotkey press triggers "Start Recording" action
5. Hotkey release triggers "Stop Recording" action (push-to-talk mode)
6. Conflict detection: warn if hotkey is already registered by another app
7. Graceful degradation if hotkey registration fails (fallback to tray menu)

## Tasks / Subtasks

- [x] **Task 1: Add Global Hotkey Dependencies** (AC: 1)
  - [x] Add `tauri-plugin-global-shortcut` to Cargo.toml
  - [x] Add plugin to Tauri capabilities
  - [x] Initialize plugin in Tauri setup

- [x] **Task 2: Create Hotkey Service** (AC: 1, 2)
  - [x] Create `src-tauri/src/services/hotkey/mod.rs`
  - [x] Implement `HotkeyState` struct
  - [x] Define default hotkeys per platform
  - [x] Store registered hotkey in AppState

- [x] **Task 3: Implement Hotkey Registration** (AC: 2, 3)
  - [x] Register default hotkey on app startup
  - [x] Parse hotkey string to keybinding
  - [x] Handle registration errors
  - [x] Log successful registration

- [x] **Task 4: Implement Push-to-Talk Mode** (AC: 4, 5)
  - [x] Detect key press event → start recording
  - [x] Detect key release event → stop recording
  - [x] Handle rapid press/release (debounce)
  - [x] Maintain state between events

- [x] **Task 5: Implement Conflict Detection** (AC: 6)
  - [x] Catch registration error indicating conflict
  - [x] Store conflict info in state
  - [x] Emit event to frontend
  - [x] Allow user to choose alternative hotkey

- [x] **Task 6: Implement Graceful Degradation** (AC: 7)
  - [x] If hotkey registration fails, continue without it
  - [x] Show notification to user
  - [x] Tray menu recording still works
  - [x] Log warning with tracing

- [x] **Task 7: Create Tauri Commands**
  - [x] `set_hotkey(hotkey: String)` - Set new hotkey
  - [x] `clear_hotkey()` - Remove current hotkey
  - [x] `get_current_hotkey() -> String` - Get active hotkey
  - [x] `check_hotkey_available(hotkey: String) -> bool` - Check if hotkey is available

- [x] **Task 8: Add Frontend Hotkey Display**
  - [x] Create hotkey display component
  - [x] Show current hotkey in settings
  - [x] Add to Settings panel (Story 2.5)

- [x] **Task 9: Add Unit Tests**
  - [x] Test hotkey string parsing
  - [x] Test conflict detection
  - [x] Test state management

## Dev Notes

### Dependencies

```toml
# src-tauri/Cargo.toml
[dependencies]
tauri-plugin-global-shortcut = "2"
```

```json
// src-tauri/capabilities/default.json
{
  "permissions": [
    "global-shortcut:default"
  ]
}
```

### Hotkey Service Implementation [Source: architecture.md#8.5]

```rust
// src-tauri/src/services/platform/hotkey.rs
use tauri_plugin_global_shortcut::{GlobalShortcutExt, Shortcut, ShortcutState};
use std::sync::Arc;
use tokio::sync::RwLock;

pub struct HotkeyService {
    current_hotkey: Arc<RwLock<Option<String>>>,
    is_recording: Arc<RwLock<bool>>,
}

impl HotkeyService {
    pub fn new() -> Self {
        Self {
            current_hotkey: Arc::new(RwLock::new(None)),
            is_recording: Arc::new(RwLock::new(false)),
        }
    }

    pub fn get_default_hotkey() -> &'static str {
        #[cfg(target_os = "macos")]
        { "Cmd+Shift+Space" }
        #[cfg(not(target_os = "macos"))]
        { "Ctrl+Shift+Space" }
    }
}
```

### Tauri Setup with Global Shortcut

```rust
// src-tauri/src/main.rs
use tauri_plugin_global_shortcut::{GlobalShortcutExt, Shortcut, ShortcutState};

fn main() {
    tauri::Builder::default()
        .plugin(tauri_plugin_global_shortcut::Builder::new().build())
        .setup(|app| {
            let hotkey = HotkeyService::get_default_hotkey();

            // Register with push-to-talk handling
            app.global_shortcut().on_shortcut(hotkey, move |_app, shortcut, event| {
                match event.state {
                    ShortcutState::Pressed => {
                        tracing::info!("Hotkey pressed - starting recording");
                        // Start recording
                    }
                    ShortcutState::Released => {
                        tracing::info!("Hotkey released - stopping recording");
                        // Stop recording and transcribe
                    }
                }
            })?;

            tracing::info!("Registered global hotkey: {}", hotkey);
            Ok(())
        })
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

### Hotkey Conflict Handling

```rust
pub fn register_hotkey(app: &AppHandle, hotkey: &str) -> Result<(), HotkeyError> {
    match app.global_shortcut().register(hotkey) {
        Ok(_) => {
            tracing::info!("Hotkey registered: {}", hotkey);
            Ok(())
        }
        Err(e) => {
            if e.to_string().contains("already registered") {
                Err(HotkeyError::Conflict(hotkey.to_string()))
            } else {
                Err(HotkeyError::RegistrationFailed(e.to_string()))
            }
        }
    }
}

#[derive(Error, Debug)]
pub enum HotkeyError {
    #[error("Hotkey '{0}' is already registered by another application")]
    Conflict(String),

    #[error("Failed to register hotkey: {0}")]
    RegistrationFailed(String),
}
```

### Frontend Hotkey Display

```typescript
// src/lib/services/hotkeys.ts
export function formatHotkey(hotkey: string): string {
  const isMac = navigator.platform.includes('Mac');

  return hotkey
    .replace('Cmd', isMac ? '⌘' : 'Ctrl')
    .replace('Ctrl', isMac ? '⌃' : 'Ctrl')
    .replace('Shift', isMac ? '⇧' : 'Shift')
    .replace('Alt', isMac ? '⌥' : 'Alt')
    .replace('+', ' + ');
}
```

### File Locations

| File | Purpose |
|------|---------|
| `src-tauri/src/services/platform/hotkey.rs` | Hotkey service |
| `src/lib/services/hotkeys.ts` | Frontend hotkey utilities |
| `src/lib/components/HotkeyDisplay.svelte` | Display component |

### Error Types

```rust
#[derive(Error, Debug)]
pub enum HotkeyError {
    #[error("Hotkey '{0}' is already in use by another application")]
    Conflict(String),

    #[error("Failed to register hotkey: {0}")]
    RegistrationFailed(String),

    #[error("Invalid hotkey format: {0}")]
    InvalidFormat(String),
}
```

### Testing

**Test Scenarios**:
- `test_default_hotkey_per_platform` - Correct default on each OS
- `test_hotkey_string_parsing` - Valid hotkey formats parsed
- `test_conflict_detection` - Conflicts properly detected

**Manual Testing**:
- Open another app, register same hotkey, verify conflict warning
- Test hotkey works when EZ Flow is minimized
- Test push-to-talk: hold -> release

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
N/A

### Completion Notes List
- Global hotkey service implemented in `src-tauri/src/services/hotkey/mod.rs`
- All Tauri commands implemented in `src-tauri/src/commands/hotkey.rs`
- Push-to-talk mode with key press/release events
- Graceful degradation on registration failure
- Frontend hotkey display in Settings panel

### File List
- `src-tauri/Cargo.toml` (modified - added tauri-plugin-global-shortcut)
- `src-tauri/capabilities/default.json` (modified - added global-shortcut permission)
- `src-tauri/src/services/hotkey/mod.rs` (created)
- `src-tauri/src/commands/hotkey.rs` (created)
- `src-tauri/src/lib.rs` (modified - registered hotkey commands)
- `src/lib/components/HotkeyDisplay.svelte` (created)

---

## QA Results
*To be filled by QA agent*
