# Story 2.1: Global Hotkey Registration

## Status

Draft

## Story

**As a** user,
**I want** to trigger recording with a keyboard shortcut from any application,
**so that** I can start dictating without switching windows.

## Acceptance Criteria

1. Global hotkey registration using `tauri-plugin-global-shortcut` or platform APIs
2. Default hotkey: `Ctrl+Shift+Space` (Windows/Linux), `Cmd+Shift+Space` (macOS)
3. Hotkey works when EZ Flow is in background (any app focused)
4. Hotkey press triggers "Start Recording" action
5. Hotkey release triggers "Stop Recording" action (push-to-talk mode)
6. Conflict detection: warn if hotkey is already registered by another app
7. Graceful degradation if hotkey registration fails (fallback to tray menu)

## Tasks / Subtasks

- [ ] **Task 1: Add Global Hotkey Dependencies** (AC: 1)
  - [ ] Add `tauri-plugin-global-shortcut` to Cargo.toml
  - [ ] Add plugin to Tauri capabilities
  - [ ] Initialize plugin in Tauri setup

- [ ] **Task 2: Create Hotkey Service** (AC: 1, 2)
  - [ ] Create `src-tauri/src/services/platform/hotkey.rs`
  - [ ] Implement `HotkeyService` struct
  - [ ] Define default hotkeys per platform
  - [ ] Store registered hotkey in AppState

- [ ] **Task 3: Implement Hotkey Registration** (AC: 2, 3)
  - [ ] Register default hotkey on app startup
  - [ ] Parse hotkey string to keybinding
  - [ ] Handle registration errors
  - [ ] Log successful registration

- [ ] **Task 4: Implement Push-to-Talk Mode** (AC: 4, 5)
  - [ ] Detect key press event → start recording
  - [ ] Detect key release event → stop recording
  - [ ] Handle rapid press/release (debounce)
  - [ ] Maintain state between events

- [ ] **Task 5: Implement Conflict Detection** (AC: 6)
  - [ ] Catch registration error indicating conflict
  - [ ] Store conflict info in state
  - [ ] Emit event to frontend
  - [ ] Allow user to choose alternative hotkey

- [ ] **Task 6: Implement Graceful Degradation** (AC: 7)
  - [ ] If hotkey registration fails, continue without it
  - [ ] Show notification to user
  - [ ] Tray menu recording still works
  - [ ] Log warning with tracing

- [ ] **Task 7: Create Tauri Commands**
  - [ ] `register_hotkey(hotkey: String)` - Set new hotkey
  - [ ] `unregister_hotkey()` - Remove current hotkey
  - [ ] `get_current_hotkey() -> String` - Get active hotkey
  - [ ] `test_hotkey(hotkey: String) -> bool` - Check if hotkey is available

- [ ] **Task 8: Add Frontend Hotkey Display**
  - [ ] Create hotkey display component
  - [ ] Show current hotkey in tray tooltip
  - [ ] Add to Settings panel (Story 2.5)

- [ ] **Task 9: Add Unit Tests**
  - [ ] Test hotkey string parsing
  - [ ] Test conflict detection
  - [ ] Test state management

## Dev Notes

### Dependencies

```toml
# src-tauri/Cargo.toml
[dependencies]
tauri-plugin-global-shortcut = "2"
```

```json
// src-tauri/capabilities/default.json
{
  "permissions": [
    "global-shortcut:default"
  ]
}
```

### Hotkey Service Implementation [Source: architecture.md#8.5]

```rust
// src-tauri/src/services/platform/hotkey.rs
use tauri_plugin_global_shortcut::{GlobalShortcutExt, Shortcut, ShortcutState};
use std::sync::Arc;
use tokio::sync::RwLock;

pub struct HotkeyService {
    current_hotkey: Arc<RwLock<Option<String>>>,
    is_recording: Arc<RwLock<bool>>,
}

impl HotkeyService {
    pub fn new() -> Self {
        Self {
            current_hotkey: Arc::new(RwLock::new(None)),
            is_recording: Arc::new(RwLock::new(false)),
        }
    }

    pub fn get_default_hotkey() -> &'static str {
        #[cfg(target_os = "macos")]
        { "Cmd+Shift+Space" }
        #[cfg(not(target_os = "macos"))]
        { "Ctrl+Shift+Space" }
    }
}
```

### Tauri Setup with Global Shortcut

```rust
// src-tauri/src/main.rs
use tauri_plugin_global_shortcut::{GlobalShortcutExt, Shortcut, ShortcutState};

fn main() {
    tauri::Builder::default()
        .plugin(tauri_plugin_global_shortcut::Builder::new().build())
        .setup(|app| {
            let hotkey = HotkeyService::get_default_hotkey();

            // Register with push-to-talk handling
            app.global_shortcut().on_shortcut(hotkey, move |_app, shortcut, event| {
                match event.state {
                    ShortcutState::Pressed => {
                        tracing::info!("Hotkey pressed - starting recording");
                        // Start recording
                    }
                    ShortcutState::Released => {
                        tracing::info!("Hotkey released - stopping recording");
                        // Stop recording and transcribe
                    }
                }
            })?;

            tracing::info!("Registered global hotkey: {}", hotkey);
            Ok(())
        })
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

### Hotkey Conflict Handling

```rust
pub fn register_hotkey(app: &AppHandle, hotkey: &str) -> Result<(), HotkeyError> {
    match app.global_shortcut().register(hotkey) {
        Ok(_) => {
            tracing::info!("Hotkey registered: {}", hotkey);
            Ok(())
        }
        Err(e) => {
            if e.to_string().contains("already registered") {
                Err(HotkeyError::Conflict(hotkey.to_string()))
            } else {
                Err(HotkeyError::RegistrationFailed(e.to_string()))
            }
        }
    }
}

#[derive(Error, Debug)]
pub enum HotkeyError {
    #[error("Hotkey '{0}' is already registered by another application")]
    Conflict(String),

    #[error("Failed to register hotkey: {0}")]
    RegistrationFailed(String),
}
```

### Frontend Hotkey Display

```typescript
// src/lib/services/hotkeys.ts
export function formatHotkey(hotkey: string): string {
  const isMac = navigator.platform.includes('Mac');

  return hotkey
    .replace('Cmd', isMac ? '⌘' : 'Ctrl')
    .replace('Ctrl', isMac ? '⌃' : 'Ctrl')
    .replace('Shift', isMac ? '⇧' : 'Shift')
    .replace('Alt', isMac ? '⌥' : 'Alt')
    .replace('+', ' + ');
}
```

### File Locations

| File | Purpose |
|------|---------|
| `src-tauri/src/services/platform/hotkey.rs` | Hotkey service |
| `src/lib/services/hotkeys.ts` | Frontend hotkey utilities |
| `src/lib/components/HotkeyDisplay.svelte` | Display component |

### Error Types

```rust
#[derive(Error, Debug)]
pub enum HotkeyError {
    #[error("Hotkey '{0}' is already in use by another application")]
    Conflict(String),

    #[error("Failed to register hotkey: {0}")]
    RegistrationFailed(String),

    #[error("Invalid hotkey format: {0}")]
    InvalidFormat(String),
}
```

### Testing

**Test Scenarios**:
- `test_default_hotkey_per_platform` - Correct default on each OS
- `test_hotkey_string_parsing` - Valid hotkey formats parsed
- `test_conflict_detection` - Conflicts properly detected

**Manual Testing**:
- Open another app, register same hotkey, verify conflict warning
- Test hotkey works when EZ Flow is minimized
- Test push-to-talk: hold -> release

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 0.1 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
